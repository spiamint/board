<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hello.board.repository.mybatis.BoardMapper">

    <!-- 파라미터를 #{param} 과 ${param} 사용
        #{param} 는 파라미터 바인딩 으로, param = ? ('param') 으로 바인딩.
        ${param} 은 replace 로, param = ? (param) 으로 대체 -> column 이름 등으로 사용가능 but SQL injection 방어불가
        -->

    <!--countTotalBoard-->
    <select id="countTotalBoard" resultType="Integer">
        select count(*) from board
        <where>
            <if test="category != null and category.name() != 'ALL'">
                and category = #{category}
            </if>
            <if test="keyword != null and keyword != ''">
                and ${option} like concat('%',#{keyword},'%')
            </if>
        </where>
    </select>

    <!--countTotalBoard-->
    <select id="countTotalBoardWithMemberId" resultType="Integer">
        select count(*) from board
        <where>
            member_id = #{memberId}
            <if test="criteria.category != null and criteria.category.name() != 'ALL'">
                and category = #{criteria.category}
            </if>
            <if test="criteria.keyword != null and criteria.keyword != ''">
                and ${criteria.option} like concat('%',#{criteria.keyword},'%')
            </if>
        </where>
    </select>

    <!-- updateViewCount -->
    <update id="updateViewCount">
        update board
        set view_count = view_count + 1
        where id = #{id}
    </update>

    <!-- findById -->
    <select id="findById" resultType="Board">
        select * from board
        where id = #{id}
    </select>

    <!-- 페이징 처리된 select -->
    <!-- resultType = "hashmap" parameterType = "hashmap" 으로 List<Map<String, Object>> 로 받던데 이유 모르겟음-->
    <!-- 로그 확인 결과 starPageNum 멤버가 없음에도 getStarPageNum() 메서드의 영향인지 파라미터가 정상적으로 넘어감; -->
    <select id="findPagedBoard" resultType="Board">
        select * from board
        <!-- where 의 if 가 true 면 where 생성, ${option} 으로 문자열 아닌 컬럼명으로 인식 -->
        <where>
            <if test="category != null and category.name() != 'ALL'">
                and category = #{category}
            </if>
            <if test="keyword != null and keyword != ''">
                and ${option} like concat('%',#{keyword},'%')
            </if>
        </where>
        order by id desc
        limit #{startRowNum}, #{contentPerPage}
    </select>

    <select id="findPagedBoardWithMemberId" resultType="Board">
        select * from board
        <where>
            member_id = #{memberId}
            <if test="criteria.category != null and criteria.category.name() != 'ALL'">
                and category = #{criteria.category}
            </if>
            <if test="criteria.keyword != null and criteria.keyword != ''">
                and ${criteria.option} like concat('%',#{criteria.keyword},'%')
            </if>
        </where>
        order by id desc
        limit #{criteria.startRowNum}, #{criteria.contentPerPage}
    </select>

    <!-- save, 자동생성(auto increment) key 사용 -->
    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        insert into board (title, content, writer, reg_date, update_date, member_id, category)
        values (#{title}, #{content}, #{writer}, #{regDate}, #{updateDate}, #{memberId}, #{category})
    </insert>

    <!-- update -->
    <update id="update">
        update board
        set title=#{updateParam.title},
            writer=#{updateParam.writer},
            content=#{updateParam.content},
            update_date=#{updateParam.updateDate},
            category=#{updateParam.category}
        where id = #{id}
    </update>

    <update id="syncWriter">
        update board
        set writer = #{updateName}
        where member_id = #{memberId}
    </update>

    <!-- delete -->
    <delete id="delete">
        delete from board where id = #{id}
    </delete>


</mapper>

